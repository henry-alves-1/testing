name: Print Changed Files

on:
  push:

jobs:
  print-changed-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if merge commit
        id: check_merge
        run: |
          PARENT_COUNT=$(git log -1 --format="%P" | wc -w)
          echo "parent_count=$PARENT_COUNT" >> $GITHUB_OUTPUT

      - name: Print changed files
        if: github.ref == 'refs/heads/main' || steps.check_merge.outputs.parent_count == '1'
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          # If github.event.before is all zeros (new branch), fall back to the commit's parent
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            echo "New branch detected — comparing against parent commit of the pushed commit."
            BEFORE="${AFTER}^"
          fi

          echo "Comparing $BEFORE → $AFTER"
          echo "================================================"

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only "$BEFORE" "$AFTER")

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No files changed."
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "================================================"

          # Print contents of each changed file
          while IFS= read -r file; do
            echo ""
            echo "###############################################"
            echo "FILE: $file"
            echo "###############################################"
            if [[ -f "$file" ]]; then
              cat "$file"
            else
              echo "(file was deleted)"
            fi
          done <<< "$CHANGED_FILES"