name: Print Changed Files

on:
  push:

jobs:
  print-changed-files:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print changed files (non-main)
        if: github.ref != 'refs/heads/main'
        run: |
          BASE_REF="${{ github.event.before }}"
          HEAD_REF="${{ github.event.after }}"

          PARENT_COUNT=$(git log -1 --format="%P" $HEAD_REF | wc -w)

          if [ "$PARENT_COUNT" -gt 1 ]; then
            PARENT1=$(git log -1 --format="%P" $HEAD_REF | awk '{print $1}')
            PARENT2=$(git log -1 --format="%P" $HEAD_REF | awk '{print $2}')
            echo "Files changed beyond the merge (e.g. conflict resolutions):"
            git diff --name-only $PARENT2 $HEAD_REF
          else
            git diff --name-only $BASE_REF $HEAD_REF
          fi

      - name: Print changed files (main)
        if: github.ref == 'refs/heads/main'
        run: |
          BASE_REF="${{ github.event.before }}"
          HEAD_REF="${{ github.event.after }}"

          git diff --name-only $BASE_REF $HEAD_REF

      - name: Print changed files
        if: github.ref == 'refs/heads/main' || steps.check_merge.outputs.parent_count == '1'
        run: |
          BEFORE="${{ github.event.before }}"
          AFTER="${{ github.event.after }}"

          # If github.event.before is all zeros (new branch), fall back to the commit's parent
          if [[ "$BEFORE" == "0000000000000000000000000000000000000000" ]]; then
            echo "New branch detected — comparing against parent commit of the pushed commit."
            BEFORE="${AFTER}^"
          fi

          echo "Comparing $BEFORE → $AFTER"
          echo "================================================"

          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only "$BEFORE" "$AFTER")

          if [[ -z "$CHANGED_FILES" ]]; then
            echo "No files changed."
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"
          echo "================================================"

          # Print contents of each changed file
          while IFS= read -r file; do
            echo ""
            echo "###############################################"
            echo "FILE: $file"
            echo "###############################################"
            if [[ -f "$file" ]]; then
              cat "$file"
            else
              echo "(file was deleted)"
            fi
          done <<< "$CHANGED_FILES"